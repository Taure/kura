name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: root
          POSTGRES_DB: kura_test
        ports:
          - 5555:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - uses: erlef/setup-beam@v1
        with:
          otp-version: '27'
          rebar3-version: '3.24'

      - name: Compile
        run: rebar3 compile

      - name: EUnit
        run: rebar3 eunit

      - name: Generate docs
        run: rebar3 ex_doc

      - name: Extract changelog for release
        id: changelog
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          BODY=$(awk "/^## \[${VERSION}\]/{flag=1; next} /^## \[/{flag=0} flag" CHANGELOG.md)
          {
            echo 'body<<EOF'
            echo "$BODY"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        run: |
          gh release create "$GITHUB_REF_NAME" \
            --title "$GITHUB_REF_NAME" \
            --notes "${{ steps.changelog.outputs.body }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to Hex
        run: rebar3 hex publish --yes
        env:
          HEX_API_KEY: ${{ secrets.HEX_API_KEY }}
